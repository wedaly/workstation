#!/usr/bin/env sh
set -e

{{ if eq .chezmoi.os "linux" -}}
{{ if eq .chezmoi.osRelease.id "ubuntu" -}}
echo "Installing system packages (apt)"
sudo apt update
sudo apt install \
    vim \
    wget \
    curl \
    git \
    tmux \
    keychain \
    tree \
    jq \
    ripgrep \
    fzf \
    htop \
    python3 \
    python3-pip \
    universal-ctags
{{ else if eq .chezmoi.osRelease.id "fedora" -}}
echo "Installing system packages (dnf)"
sudo dnf update
sudo dnf install \
    vim \
    wget \
    curl \
    git \
    make \
    tmux \
    tree \
    jq \
    sd \
    ripgrep \
    fzf \
    htop \
    python3 \
    ctags
{{ end -}}
{{ end -}}

echo "Installing rust"
RUST_VERSION=1.73.0
if ! (gpg --list-keys | grep "0x85AB96E6FA1BE5FE"); then
    curl https://keybase.io/rust/pgp_keys.asc | gpg --import
fi
if (which rustc && rustc --version | cut -d ' ' -f 2 | grep $RUST_VERSION); then
    echo "rust v$RUST_VERSION is already installed"
else
    RUST_TARBALL="rust-${RUST_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
    RUST_TARBALL_SIG="${RUST_TARBALL}.asc"
    RUST_TARBALL_URL="https://static.rust-lang.org/dist/${RUST_TARBALL}"
    RUST_TARBALL_SIG_URL="https://static.rust-lang.org/dist/${RUST_TARBALL_SIG}"
    RUST_INSTALL_SCRIPT="/tmp/$(basename $RUST_TARBALL .tar.gz)/install.sh"
    (cd /tmp && rm -rf "$RUST_TARBALL" && rm -rf $RUST_TARBALL_SIG && wget $RUST_TARBALL_URL && wget $RUST_TARBALL_SIG_URL && gpg --verify $RUST_TARBALL_SIG)
    sudo bash "$RUST_INSTALL_SCRIPT"
fi

echo "Installing go"
GO_VERSION=1.21.4
GO_SHA256SUM=73cac0215254d0c7d1241fa40837851f3b9a8a742d0b54714cbdfb3feaf8f0af
if (which go && go version | cut -d ' ' -f 3 | grep "go$GO_VERSION"); then
    echo "go v$GO_VERSION is already installed"
else
    GO_OS={{ .chezmoi.os }}
    GO_ARCH={{ .chezmoi.arch }}
    GO_TARBALL="go${GO_VERSION}.${GO_OS}-${GO_ARCH}.tar.gz"
    (cd /tmp && rm -rf "$GO_TARBALL" && wget https://go.dev/dl/${GO_TARBALL} && echo "$GO_SHA256SUM  $GO_TARBALL" | sha256sum --check --status)
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf "/tmp/$GO_TARBALL"
    export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
fi

echo "Installing go devtools"
go install golang.org/x/tools/cmd/goimports@latest
go install github.com/go-delve/delve/cmd/dlv@latest
go install github.com/shurcooL/markdownfmt@latest
go install honnef.co/go/tools/cmd/staticcheck@latest
go install github.com/wedaly/gospelunk@latest

echo "Installing aretext"
(cd /tmp && rm -rf aretext && git clone https://github.com/aretext/aretext && cd aretext && make install)
